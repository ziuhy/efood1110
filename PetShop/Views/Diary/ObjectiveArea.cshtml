@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var recommendFoods = ViewBag.RecommendFoods as List<PetShop.Models.CommonFood>;
    //ViewBag.Title = "目標設定";

    // 從 ViewBag 取得會員資料（由 HomeController 傳入）
    var member = ViewBag.Member as PetShop.Models.RegisterUser ?? new PetShop.Models.RegisterUser
    {
        RegisterHeight = 0,
        RegisterWeight = 0
    };

    // 計算 BMI
    float heightInMeters = member.RegisterHeight / 100; // 將公分換算成公尺
    float bmi = heightInMeters > 0 ? (float)Math.Round(member.RegisterWeight / (heightInMeters * heightInMeters), 1) : 0;

    // 判斷體重狀態
    string weightStatus = "未知";
    if (bmi > 0)
    {
        if (bmi < 18.5)
        {
            weightStatus = "過輕";
        }
        else if (bmi >= 18.5 && bmi < 24)
        {
            weightStatus = "適中";
        }
        else
        {
            weightStatus = "過重";
        }
    }

    // 計算基礎代謝率（BMR）與每日建議熱量（以男性、30歲、中度活動為假設）
    int assumedAge = 30;
    double bmr = 10 * member.RegisterWeight + 6.25 * member.RegisterHeight - 5 * assumedAge + 5;
    double dailyCalories = Math.Round(bmr * 1.55, 0); // 中度活動係數
}
<style>
    .page-title {
        text-align: left; /* 水平靠左 */
        margin-left: 10px; /* 可選，與 page-wrapper 左側對齊 */
    }

    .menu-icon {
        width: 65px; /* 可依需求調整 */
        height: 65px;
        border-radius: 5px;
        text-align: left;
        justify-content: flex-start
    }

    .card {
        background: #8e8480;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 200px;
        display: flex;
        justify-content: center;
    }
</style>
<div class="card">
    <img src="~/Image/目標設定icon.png" alt="目標設定icon" class="menu-icon">
    <h2 class="page-title"> 目標設定</h2>
</div>

<!-- 主內容區：兩欄式版面 -->
<div style="display: flex; height: 70vh; width: 95%; margin: 0 auto; padding: 0; position: relative; z-index: 1;">
    <!-- 左半部：基本資料 -->
    <div style="flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: flex-start; width: 30%; max-width: 33vw;">
        @*<h2 style="margin: 0 0 20px 0; align-self: flex-start;">目標設定</h2>*@
        <div style="width: 70%; border: 2px solid #ccc; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; justify-content: flex-start; position: relative; height: calc(100% - 60px); background-color: #fff;">
            <!-- 標題與會員照片 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0 auto; font-size: 20px;">基本資料</h3>
                @if (Session["LoginUser"] != null && Session["ImageName"] != null)
                {
                    <a href="@Url.Action("MemberInfo", "Home", new { account = Session["LoginUser"] })">
                        <img src="@Url.Content("~/Photo/" + Session["ImageName"])" alt="會員照片" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;" />
                    </a>
                }
            </div>
            <hr style="border: 1px solid #ccc; margin: 10px 0;" />
            <!-- 顯示會員資訊 -->
            <div style="display: flex; flex-direction: column; align-items: flex-start; font-size: 20px;">
                <div style="margin-bottom: 10px;">身高: @member.RegisterHeight cm</div>
                <div style="margin-bottom: 10px;">體重: @member.RegisterWeight kg</div>
                <div style="margin-bottom: 10px;">BMI: @bmi</div>
                <div>體重狀態: @weightStatus</div>
            </div>
        </div>
    </div>

    <!-- 中間間隔 -->
    @*<div style="width: 8%;"></div>*@

    <!-- 右半部：目標設定與熱量分析 -->
    <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: flex-start; width: 50%;">
        <!-- 目標設定方框 -->
        <div style="width:260px; border: 2px solid #ccc; border-radius: 10px; padding: 20px; margin-bottom: 20px; height: calc(60% - 20px); background-color: #fff;">
            <h3 style="margin: 0 0 20px 0; font-size: 20px;">設定目標</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="font-size: 18px; margin-right: 10px;">目標時間（天）:</label>
                    <input type="number" id="targetDays" name="targetDays" value="@ViewBag.TargetDays" min="7" style="font-size: 16px; padding: 5px; width: 100px;" />
                </div>
                <div>
                    <label style="font-size: 18px; margin-right: 10px;">目標體重（kg）:</label>
                    <input type="number" id="targetWeight" name="targetWeight" value="@ViewBag.TargetWeight" step="0.1" min="0" style="font-size: 16px; padding: 5px; width: 100px;" />
                </div>
                <div>
                    <button id="updateGoal" style="font-size: 16px; padding: 8px 16px; background-color: #565b5e; color: white; border: none; border-radius: 5px; cursor: pointer;">更新目標</button>
                    <span id="goalStatus"></span>
                </div>
            </div>
        </div>
        <div style="flex: 1; display: flex; flex-direction: row; gap: 5px; height: calc(40% - 20px); justify-content: center; ">
            <!-- 每日所需熱量方框 -->
            <div style="width:110px ; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative; background-color: #fff;">
                <h3 style="margin: 0 0 10px 0; font-size: 15px;">每日所需熱量</h3>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    <span id="dailyCaloriesValue" style="font-size: 40px; font-weight: bold;">@ViewBag.DailyCalories</span>
                    <input type="hidden" id="dailyCaloriesInput" name="dailyCalories" value="@dailyCalories" />
                </div>
                <div style="position: absolute; bottom: 10px; right: 10px; font-size: 16px; color: #666;">kcal</div>
            </div>
            <!-- 每日飲食熱量方框 -->
            <div style="width:110px; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative; background-color: #fff;">
                <h3 style="margin: 0 0 10px 0; font-size: 15px;">今日飲食總熱量</h3>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 40px; font-weight: bold;">@ViewBag.TodayCalories</span>
                </div>
                <div style="position: absolute; bottom: 10px; right: 10px; font-size: 16px; color: #666;">kcal</div>
            </div>
        </div>
    </div>

    <!-- 中間間隔 -->
    @*<div style="width: 8%;"></div>*@

    <div style="width: 20%;">

        <!-- 熱量差距方框 -->
        <div style="width: 100%; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative;  background-color: #fff;">
            <h3 style="margin: 0 0 10px 0; font-size: 20px;">熱量差距</h3>
            <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 40px; font-weight: bold;">@ViewBag.CalorieDiff</span>
            </div>
            <div style="position: absolute; bottom: 10px; right: 10px; font-size: 16px; color: #666;">kcal</div>
        </div>

        <!-- 推薦食物清單 -->
        <div style="width: 100%; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative; height: calc(40% - 20px); background-color: #fff;">
            @if (recommendFoods != null && recommendFoods.Count > 0)
            {
                <div>
                    @if (ViewBag.CalorieDiff > 0)
                    {
                        <h3 style="margin: 0 0 10px 0; font-size: 20px;">建議補充以下食物：</h3>
                    }
                    else
                    {
                        <h3 style="margin: 0 0 10px 0; font-size: 20px;">建議減少以下食物：</h3>
                    }
                    <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <ul style="list-style-type: disc; padding-left: 20px; text-align: left;">
                            @foreach (var food in recommendFoods)
                            {
                                <li style="font-size: 15px; margin-bottom: 8px;">@food.Name (@food.Calories kcal)</li>
                            }
                        </ul>
                    </div>
                </div>
            }
            else
            {
                <div style="text-align: center; color: #888; font-size: 16px;">無推薦食物</div>
            }
        </div>

        <div style="border: 2px solid #565b5e; border-radius: 10px; padding: 20px; background-color: #f8f9fa; width: 100%; height: calc(20% - 20px); ">
            <h3 style="margin: 0 0 10px 0; font-size: 20px;">🤖 AI 營養師分析</h3>
            <div style="text-align: center; margin-bottom: 15px;">
                <button id="getAiAnalysisBtn" style="font-size: 16px; padding: 8px 16px; background-color: #565b5e; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    產生個人化飲食建議
                </button>
            </div>
            <div id="aiResultSpinner" style="display: none; text-align: center;">
                <p>AI 營養師正在分析中，請稍候...</p>
            </div>
            <div id="aiResultContainer" style="font-size: 16px; line-height: 1.6; white-space: pre-wrap;">
            </div>
        </div>
    </div>
</div>

<!-- JavaScript（處理更新目標按鈕） -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // 監聽更新目標按鈕
        $('#updateGoal').click(function () {
            var targetDays = $('#targetDays').val();
            var targetWeight = $('#targetWeight').val();
            var account = '@Session["LoginUser"]';

            if (!targetDays || targetDays < 1) {
                alert('請輸入有效的目標天數（至少1天）');
                return;
            }
            if (!targetWeight || targetWeight <= 0) {
                alert('請輸入有效的目標體重（大於0）');
                return;
            }

            // AJAX 提交目標資料到後端
            $.ajax({
                url: '@Url.Action("SaveObjective", "Home")',
                type: 'POST',
                data: {
                    account: account,
                    targetDays: targetDays,
                    targetWeight: targetWeight,
                    dailyCalories: $('#dailyCaloriesInput').val()
                },
                success: function (response) {
                    if (response.success) {
                        alert('目標更新成功！');
                        // 更新每日所需熱量顯示
                        $('#dailyCaloriesValue').text(response.dailyCalories);
                        $('#dailyCaloriesInput').val(response.dailyCalories);
                        $('#goalStatus').text(response.goalStatus);
                    } else {
                        alert('目標更新失敗：' + response.message);
                    }
                },
                error: function () {
                    alert('無法連接到伺服器，請稍後再試。');
                }
            });
        });
    });

    // 監聽 AI 分析按鈕的點擊事件
$('#getAiAnalysisBtn').click(function () {
    var btn = $(this);
    var resultContainer = $('#aiResultContainer');
    var spinner = $('#aiResultSpinner');

    btn.prop('disabled', true).text('分析中...');
    spinner.show();
    resultContainer.html('');

    $.ajax({
        url: '@Url.Action("GenerateAiAnalysis", "Home")',
        type: 'POST',
        success: function (response) {
            if (response.success) {
                resultContainer.text(response.analysis);
            } else {
                resultContainer.html('<p style="color: red;">分析失敗：' + response.message + '</p>');
            }
        },
        error: function () {
            resultContainer.html('<p style="color: red;">無法連接到伺服器，請稍後再試。</p>');
        },
        complete: function () {
            spinner.hide();
            btn.prop('disabled', false).text('重新產生飲食建議');
        }
    });
});

</script>