@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var recommendFoods = ViewBag.RecommendFoods as List<PetShop.Models.CommonFood>;
    //ViewBag.Title = "目標設定";

    // 從 ViewBag 取得會員資料（由 HomeController 傳入）
    var member = ViewBag.Member as PetShop.Models.RegisterUser ?? new PetShop.Models.RegisterUser
    {
        RegisterHeight = 0,
        RegisterWeight = 0
    };

    // 計算 BMI
    float heightInMeters = member.RegisterHeight / 100; // 將公分換算成公尺
    float bmi = heightInMeters > 0 ? (float)Math.Round(member.RegisterWeight / (heightInMeters * heightInMeters), 1) : 0;

    // 判斷體重狀態
    string weightStatus = "未知";
    if (bmi > 0)
    {
        if (bmi < 18.5)
        {
            weightStatus = "過輕";
        }
        else if (bmi >= 18.5 && bmi < 24)
        {
            weightStatus = "適中";
        }
        else
        {
            weightStatus = "過重";
        }
    }

    // 計算基礎代謝率（BMR）與每日建議熱量（以男性、30歲、中度活動為假設）
    int assumedAge = 30;
    double bmr = 10 * member.RegisterWeight + 6.25 * member.RegisterHeight - 5 * assumedAge + 5;
    double dailyCalories = Math.Round(bmr * 1.55, 0); // 中度活動係數
}
<style>
    .page-title {
        text-align: left; /* 水平靠左 */
        margin-left: 10px; /* 可選，與 page-wrapper 左側對齊 */
    }

    .menu-icon {
        width: 65px; /* 可依需求調整 */
        height: 65px;
        border-radius: 5px;
        text-align: left;
        justify-content: flex-start
    }

    .card {
        background: #8e8480;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 200px;
        display: flex;
        justify-content: center;
    }

    /* ↓↓↓ Modal CSS 樣式已加入 ↓↓↓ */
    .modal-overlay {
        display: none; /* 預設隱藏 */
        position: fixed; /* 固定在畫面上，蓋住所有東西 */
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* 如果視窗太小，允許滾動背景 */
        background-color: rgba(0,0,0,0.5); /* 半透明黑色背景 */
    }

    .modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* 垂直 10% 邊距，水平自動置中 */
        padding: 25px;
        border: 1px solid #888;
        width: 60%; /* 寬度 60% */
        max-width: 700px; /* 最大寬度 700px */
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
        animation: fadeIn 0.3s; /* 加入一點點淡入動畫 */
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
    }

    .modal-close:hover,
    .modal-close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    /* ↑↑↑ Modal CSS 樣式已加入 ↑↑↑ */
</style>
<div class="card">
    <img src="~/Image/目標設定icon.png" alt="目標設定icon" class="menu-icon">
    <h2 class="page-title"> 目標設定</h2>
</div>

<div style="display: flex; height: 70vh; width: 95%; margin: 0 auto; padding: 0; position: relative; z-index: 1;">
    <div style="flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: flex-start; width: 30%; max-width: 33vw;">
        @*<h2 style="margin: 0 0 20px 0; align-self: flex-start;">目標設定</h2>*@
        <div style="width: 70%; border: 2px solid #ccc; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; justify-content: flex-start; position: relative; height: calc(100% - 60px); background-color: #fff;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0 auto; font-size: 20px;">基本資料</h3>
                @if (Session["LoginUser"] != null && Session["ImageName"] != null)
                {
                    <a href="@Url.Action("MemberInfo", "Home", new { account = Session["LoginUser"] })">
                        <img src="@Url.Content("~/Photo/" + Session["ImageName"])" alt="會員照片" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer;" />
                    </a>
                }
            </div>
            <hr style="border: 1px solid #ccc; margin: 10px 0;" />
            <div style="display: flex; flex-direction: column; align-items: flex-start; font-size: 20px;">
                <div style="margin-bottom: 10px;">身高: @member.RegisterHeight cm</div>
                <div style="margin-bottom: 10px;">體重: @member.RegisterWeight kg</div>
                <div style="margin-bottom: 10px;">BMI: @bmi</div>
                <div>體重狀態: @weightStatus</div>
            </div>
        </div>
    </div>

    @*<div style="width: 8%;"></div>*@

    <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: flex-start; width: 50%;">
        <div style="width:260px; border: 2px solid #ccc; border-radius: 10px; padding: 20px; margin-bottom: 20px; height: calc(60% - 20px); background-color: #fff;">
            <h3 style="margin: 0 0 20px 0; font-size: 20px;">設定目標</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div>
                    <label style="font-size: 18px; margin-right: 10px;">目標時間（天）:</label>
                    <input type="number" id="targetDays" name="targetDays" value="@ViewBag.TargetDays" min="7" style="font-size: 16px; padding: 5px; width: 100px;" />
                </div>
                <div>
                    <label style="font-size: 18px; margin-right: 10px;">目標體重（kg）:</label>
                    <input type="number" id="targetWeight" name="targetWeight" value="@ViewBag.TargetWeight" step="0.1" min="0" style="font-size: 16px; padding: 5px; width: 100px;" />
                </div>
                <div>
                    <button id="updateGoal" style="font-size: 16px; padding: 8px 16px; background-color: #565b5e; color: white; border: none; border-radius: 5px; cursor: pointer;">更新目標</button>
                    <span id="goalStatus"></span>
                </div>
            </div>
        </div>
        <div style="flex: 1; display: flex; flex-direction: row; gap: 5px; height: calc(40% - 20px); justify-content: center; ">
            <div style="width:110px ; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative; background-color: #fff;">
                <h3 style="margin: 0 0 10px 0; font-size: 15px;">每日所需熱量</h3>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    <span id="dailyCaloriesValue" style="font-size: 40px; font-weight: bold;">@ViewBag.DailyCalories</span>
                    <input type="hidden" id="dailyCaloriesInput" name="dailyCalories" value="@dailyCalories" />
                </div>
                <div style="position: absolute; bottom: 10px; right: 10px; font-size: 16px; color: #666;">kcal</div>
            </div>
            <div style="width:110px; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative; background-color: #fff;">
                <h3 style="margin: 0 0 10px 0; font-size: 15px;">今日飲食總熱量</h3>
                <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 40px; font-weight: bold;">@ViewBag.TodayCalories</span>
                </div>
                <div style="position: absolute; bottom: 10px; right: 10px; font-size: 16px; color: #666;">kcal</div>
            </div>
        </div>
    </div>

    @*<div style="width: 8%;"></div>*@

    <div style="width: 20%;">

        <div style="width: 100%; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative;  background-color: #fff;">
            <h3 style="margin: 0 0 10px 0; font-size: 20px;">熱量差距</h3>
            <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                <span style="font-size: 40px; font-weight: bold;">@ViewBag.CalorieDiff</span>
            </div>
            <div style="position: absolute; bottom: 10px; right: 10px; font-size: 16px; color: #666;">kcal</div>
        </div>

        <div style="width: 100%; border: 2px solid #ccc; border-radius: 10px; padding: 20px; position: relative; height: calc(40% - 20px); background-color: #fff;">
            @if (recommendFoods != null && recommendFoods.Count > 0)
            {
                <div>
                    @if (ViewBag.CalorieDiff > 0)
                    {
                        <h3 style="margin: 0 0 10px 0; font-size: 20px;">建議補充以下食物：</h3>
                    }
                    else
                    {
                        <h3 style="margin: 0 0 10px 0; font-size: 20px;">建議減少以下食物：</h3>
                    }
                    <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
                        <ul style="list-style-type: disc; padding-left: 20px; text-align: left;">
                            @foreach (var food in recommendFoods)
                            {
                                <li style="font-size: 15px; margin-bottom: 8px;">@food.Name (@food.Calories kcal)</li>
                            }
                        </ul>
                    </div>
                </div>
            }
            else
            {
                <div style="text-align: center; color: #888; font-size: 16px;">無推薦食物</div>
            }
        </div>

        <div style="border: 2px solid #565b5e; border-radius: 10px; padding: 20px; background-color: #f8f9fa; width: 100%; height: calc(20% - 10px); ">
            <h3 style="margin: 0 0 10px 0; font-size: 20px;">🤖 AI 營養師分析</h3>
            <div style="text-align: center; margin-bottom: 15px;">
                <button id="getAiAnalysisBtn" style="font-size: 16px; padding: 8px 16px; background-color: #565b5e; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    產生個人化飲食建議
                </button>
            </div>
            <div id="aiResultSpinner" style="display: none; text-align: center;">
                <p>AI 營養師正在分析中，請稍候...</p>
            </div>

            <div id="aiResultContainer" style="display: none;">
            </div>
        </div>
    </div>
</div>


<div id="aiModal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close">&times;</span>

        <h3 style="margin-top: 0;">🤖 AI 營養師分析結果</h3>
        <hr>

        <div id="aiModalBody" style="white-space: pre-wrap; max-height: 50vh; overflow-y: auto;">
        </div>
    </div>
</div>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // 監聽更新目標按鈕 (您的原始程式碼，保持不變)
        $('#updateGoal').click(function () {
            var targetDays = $('#targetDays').val();
            var targetWeight = $('#targetWeight').val();
            var account = '@Session["LoginUser"]';

            if (!targetDays || targetDays < 1) {
                alert('請輸入有效的目標天數（至少1天）');
                return;
            }
            if (!targetWeight || targetWeight <= 0) {
                alert('請輸入有效的目標體重（大於0）');
                return;
            }

            // AJAX 提交目標資料到後端
            $.ajax({
                url: '@Url.Action("SaveObjective", "Home")',
                type: 'POST',
                data: {
                    account: account,
                    targetDays: targetDays,
                    targetWeight: targetWeight,
                    dailyCalories: $('#dailyCaloriesInput').val()
                },
                success: function (response) {
                    if (response.success) {
                        alert('目標更新成功！');
                        // 更新每日所需熱量顯示
                        $('#dailyCaloriesValue').text(response.dailyCalories);
                        $('#dailyCaloriesInput').val(response.dailyCalories);
                        $('#goalStatus').text(response.goalStatus);
                    } else {
                        alert('目標更新失敗：' + response.message);
                    }
                },
                error: function () {
                    alert('無法連接到伺服器，請稍後再試。');
                }
            });
        });

        // ↓↓↓ 步驟三：AJAX 呼叫已修改 ↓↓↓
        $('#getAiAnalysisBtn').click(function () {
            var btn = $(this);
            var spinner = $('#aiResultSpinner'); // 這是按鈕下方的讀取中...

            // *** 取得 Modal 的元素 ***
            var modal = $('#aiModal');
            var modalBody = $('#aiModalBody');

            btn.prop('disabled', true).text('分析中...');
            spinner.show(); // 顯示按鈕下方的「分析中...」
            modalBody.html(''); // 清空上一次的 Modal 內容

            $.ajax({
                url: '@Url.Action("GenerateAiAnalysis", "Home")',
                type: 'POST',
                success: function (response) {
                    if (response.success) {
                        // --- 這是修改的重點 ---
                        // 1. 將分析結果填入 Modal 的內容區
                        modalBody.text(response.analysis);
                        // 2. 顯示 Modal
                        modal.show();
                        // --- 修改結束 ---
                    } else {
                        // 錯誤訊息也可以顯示在 Modal 中
                        modalBody.html('<p style="color: red;">分析失敗：' + response.message + '</p>');
                        modal.show();
                    }
                },
                error: function () {
                    // 錯誤訊息也可以顯示在 Modal 中
                    modalBody.html('<p style="color: red;">無法連接到伺服器，請稍後再試。</p>');
                    modal.show();
                },
                complete: function () {
                    // 無論成功或失敗，都隱藏按鈕下方的讀取中...
                    spinner.hide();
                    btn.prop('disabled', false).text('重新產生飲食建議');
                }
            });
        });

        // ↓↓↓ 步驟四：「關閉 Modal」的 JavasScript 已加入 ↓↓↓

        // 監聽 'x' 關閉按鈕
        // 我們使用 $(document).on(...) 來確保即使是動態載入的元素也能綁定事件
        $(document).on('click', '.modal-close', function() {
            $('#aiModal').hide();
        });

        // 監聽點擊 Modal 以外的灰色區域
        $(window).on('click', function(event) {
            // 檢查點擊的對象是否就是那個灰色背景
            if ($(event.target).is('#aiModal')) {
                $('#aiModal').hide();
            }
        });

    }); // <-- 這是 $(document).ready 的結尾
</script>