@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var entries = ViewBag.UserDiaries as List<PetShop.Models.DiaryEntry>;
    //var selectedDate = ViewBag.SelectedDate as string;
    var foodList = ViewBag.FoodList as List<PetShop.Models.Food>;
    var commonFoods = ViewBag.CommonFoods as List<PetShop.Models.CommonFood>;
    bool isOther = false;
    string selectedDate = Request.QueryString["date"];

    // Diary 預設為現在的日期時間
    string diaryDateTimeValue = ViewBag.DiaryDate as string;
    if (string.IsNullOrEmpty(diaryDateTimeValue))
    {
        diaryDateTimeValue = DateTime.Now.ToString("yyyy-MM-ddTHH:mm");
        ViewBag.DiaryDate = diaryDateTimeValue;
    }

    var diaryDate = !string.IsNullOrEmpty(selectedDate) ? selectedDate : DateTime.Today.ToString("yyyy-MM-dd");
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    html, body {
        margin: 0;
    }

    .page-title {
        text-align: left; /* 水平靠左 */
        margin-left: 10px; /* 可選，與 page-wrapper 左側對齊 */
    }

    .page-wrapper {
        display: flex;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto; /* 置中 */
        /*display: flex;
        gap: 20px;
        padding: 20px;
        width: 100%;
        box-sizing: border-box;*/
    }

        .page-wrapper .container {
            flex: 1; /* 兩欄平均分 */
            min-width: 400px; /* 避免太窄 */
        }

    .container {
        flex: 0 0 35%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .diary-list-wrapper {
        flex: 1; /* 撐滿剩餘空間 */
        overflow-y: auto; /* 只對日記列表滾動 */
    }

    .diary-form-wrapper {
        flex: 0 0 40%;
        width: 100%;
        padding-left: 10px;
        overflow-y: auto;
    }

    .menu-icon {
        width: 65px; /* 可依需求調整 */
        height: 65px;
        border-radius: 5px;
        text-align: left;
        justify-content: flex-start
    }

    .card {
        background: #8e8480;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 200px;
        display: flex;
        justify-content: center;
    }
</style>

<div class="card">
    <img src="~/Image/飲食紀錄icon.png" alt="飲食紀錄icon" class="menu-icon">
    <h2 class="page-title"> 飲食紀錄</h2>
</div>

<div class="page-wrapper">
    <!-- 歷史日記顯示(左側) -->
    <div class="container mt-5" style="flex: 1 1 50%; max-width: 50%;">
        <form method="get" action="/Home/DiaryIndex" class="mb-3">
            <label for="searchDate">🔍 選擇日期查看紀錄：</label>
            @*<input type="date" id="searchDate" name="date" class="form-control"
                value="@Request.QueryString["date"]" onchange="this.form.submit()" />*@
            <input type="date" id="searchDate" name="date" class="form-control"
                   value="@diaryDate" onchange="this.form.submit()" />

        </form>

        <h4 class="mb-3">
            🕒
            @if (!string.IsNullOrEmpty(selectedDate))
            {
                <text>@selectedDate 的日記紀錄：</text>
            }
            else
            {
                <text>所有日記紀錄：</text>
            }
        </h4>
        @*<div class="diary-list-wrapper">
                @if (entries != null && entries.Count > 0)
                {
                    <ul class="list-group">
                        @foreach (var entry in entries)
                        {
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">@entry.CreateTime.ToString("yyyy-MM-dd HH:mm")</span>
                                    <span class="badge badge-secondary">日記</span>
                                </div>
                                <div class="mt-2">
                                    @if (!string.IsNullOrWhiteSpace(entry.Food))
                                    {
                                        <div><strong>食物：</strong>@entry.Food (@entry.Quantity 份)</div>
                                        <div><strong>餐別：</strong>@entry.MealType</div>
                                        <div><strong>熱量：</strong>@entry.Calories kcal</div>
                                    }
                                </div>
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteDiary(@entry.Id, this)">刪除</button>
                                <a href="@Url.Action("EditDiary", "Home", new { id = entry.Id })" class="btn btn-warning btn-sm">修改</a>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="alert alert-secondary">尚無日記紀錄。</div>
                }
            </div>*@
        <div class="diary-list-wrapper">
            @if (entries != null && entries.Count > 0)
            {
                var mealOrder = new List<string> { "早餐", "午餐", "晚餐", "點心" };
                var groupedEntries = entries
                    .GroupBy(e => e.CreateTime.Date)
                    .OrderByDescending(g => g.Key);

                foreach (var dayGroup in groupedEntries)
                {
                    <div class="diary-card">
                        <h4 class="date-title">@dayGroup.Key.ToString("yyyy-MM-dd")</h4>
                        @{
                            var meals = dayGroup
                                .GroupBy(e => e.MealType)
                                .OrderBy(g => mealOrder.IndexOf(g.Key));
                        }
                        @foreach (var mealGroup in meals)
                        {
                            @*<h6 class="meal-title">@mealGroup.Key</h6>*@
                            foreach (var entry in mealGroup.OrderBy(e => e.CreateTime))
                            {
                                <div class="meal-entry">
                                    <div class="meal-info">
                                        <div><span class="text-muted"><strong>餐別： @entry.MealType</strong></span> </div>
                                        <div>時間：@entry.CreateTime.ToString("yyyy-MM-dd HH:mm")</div>
                                        <div>食物：@entry.Food (@entry.Quantity 份)</div>
                                        <div class="nutrition-info">
                                            <div>熱量: @(entry.Calories.HasValue ? entry.Calories.Value.ToString("0.0") : "0") kcal</div>
                                            <div>蛋白質: @(entry.Protein.HasValue ? entry.Protein.Value.ToString("0.0") : "0") g</div>
                                            <div>脂肪: @(entry.Fat.HasValue ? entry.Fat.Value.ToString("0.0") : "0") g</div>
                                            <div>碳水: @(entry.Carbs.HasValue ? entry.Carbs.Value.ToString("0.0") : "0") g</div>
                                        </div>
                                    </div>
                                    <div class="meal-actions">
                                        <button type="button" class="btn btn-warning btn-sm" onclick="location.href='@Url.Action("EditDiary", "Home", new { id = entry.Id })'">修改</button>
                                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteDiary(@entry.Id, this)">刪除</button>
                                        @*<a href="@Url.Action("EditDiary", "Home", new { id = entry.Id })" class="btn btn-warning btn-sm">修改</a>*@
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            }
            else
            {
                <div class="alert alert-secondary">尚無日記紀錄。</div>
            }
        </div>

        <style>
            .diary-card {
                background: #f0eeec;
                border-radius: 12px;
                padding: 15px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            }

            .date-title {
                margin-top: 0; /* 把上方空白拿掉 */
                margin-bottom: 10px; /* 下方留一點距離，看起來不會太擠 */
                font-weight: bold;
                /*font-size: 1.3rem;
                margin-bottom: 10px;
                border-bottom: 2px solid #eee;
                padding-bottom: 5px;*/
            }

            .meal-title {
                font-weight: 600;
                margin-top: 15px;
                margin-bottom: 8px;
            }

            .meal-entry {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                background: #fff;
                padding: 12px 15px;
                border-radius: 8px;
                margin-bottom: 10px;
                border: 1px solid #eee;
            }

            .meal-info {
                flex: 1;
                min-width: 0; /* 防止文字超出 */
            }

            .nutrition-info {
                font-size: 1rem;
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                margin-top: 5px;
            }

                .nutrition-info div {
                    flex: 1 1 80px; /* 每個欄位最少 80px */
                }

            .meal-actions {
                display: flex;
                flex-direction: column;
                gap: 5px;
                margin-left: 10px;
            }
        </style>
        <style>
            .chip {
                display: inline-flex;
                align-items: center;
                background: #e0f7fa;
                border-radius: 16px;
                padding: 4px 8px;
                margin: 2px;
                font-size: 16px;
                gap: 6px;
            }

                .chip .chip-name {
                    max-width: 160px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }

                .chip .chip-qty {
                    width: 56px;
                    padding: 2px 6px;
                    border-radius: 6px;
                    border: 1px solid #cfcfcf;
                    font-size: 14px;
                }

            /* 清單定位與捲動 */
            .chip-suggest-wrapper {
                width: 100%;
            }

            .chip-suggest-list {
                position: absolute;
                top: calc(100% + 6px); /* 在輸入框下方 */
                left: 0;
                right: 0;
                max-height: 220px; /* 超過高度出現滾動 */
                overflow-y: auto;
                background: #fff;
                border-radius: 6px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.12);
                z-index: 1050;
                padding: 0;
            }

                /* 每個項目強制一列顯示且占滿寬度 */
                .chip-suggest-list .list-group-item {
                    display: block !important; /* 強制區塊顯示（避免 bootstrap-inline 衝突） */
                    width: 100% !important;
                    box-sizing: border-box;
                    padding: 8px 12px;
                    white-space: nowrap; /* 同一列顯示，超過以省略號 */
                    overflow: hidden;
                    text-overflow: ellipsis;
                    cursor: pointer;
                    border: none;
                    border-bottom: 1px solid #eee;
                }

                    /* 最後一個項目去掉下邊線 */
                    .chip-suggest-list .list-group-item:last-child {
                        border-bottom: none;
                    }

            /* 建議：避免父容器 overflow:hidden 導致被裁切 */
            .chip-suggest-wrapper, .form-group {
                overflow: visible;
            }

            .chip .close {
                margin-left: 8px;
                color: #00796b;
                cursor: pointer !important; /* 確保不被 Bootstrap 覆蓋 */
                font-weight: bold;
                user-select: none;
            }

                .chip .close:hover {
                    color: #c62828; /* 可選：hover 顏色提示 */
                    cursor: pointer !important;
                }
        </style>

    </div>
    <!-- 日記輸入表單(右側) -->
    <div class="container mt-5 diary-form-wrapper">
        <!-- 成功/失敗訊息 -->
        @if (TempData["Msg"] != null)
        {
            <div class="alert alert-info">@TempData["Msg"]</div>
        }

        <div class="form-group">
            <label for="diaryContent">✎ 新增飲食紀錄:</label>

            <form id="dateForm" method="post" action="/Home/DiaryArea">
                @Html.AntiForgeryToken()
                <label for="DiaryDate">飲食時間：</label>
                <input type="datetime-local" id="selectedDateTime" name="selectedDateTime"
                       value="@ViewBag.DiaryDate" />

                <div class="form-group mt-2">
                    <label for="MealType">用餐類別：</label>
                    <select id="MealType" name="MealType" class="form-control">
                        <option value="">-- 請選擇餐別 --</option>
                        <option value="早餐">早餐</option>
                        <option value="午餐">午餐</option>
                        <option value="晚餐">晚餐</option>
                        <option value="點心">點心</option>
                    </select>
                </div>
                <br />

                <div class="form-group">
                    <label>食物搜尋：</label>

                    <div class="chip-suggest-wrapper" style="position:relative;">
                        <input type="text" id="foodChipInput" class="form-control" placeholder="輸入食物名稱..." autocomplete="off" onkeyup="chipSuggest()" />
                        <div id="chipSuggestList" class="list-group chip-suggest-list" role="listbox" aria-label="建議清單"></div>
                    </div>

                    <div id="foodChipList" style="margin-top:10px;"></div>
                    <input type="hidden" id="selectedFoods" name="CommonFood" />
                </div>
                <br />

                @*<select id="commonSelect" name="CommonFood" onchange="onCommonSelectChange()">
            <option value="">-- 請選擇食物 --</option>
            @if (commonFoods != null)
            {
                var groupedCommon = commonFoods.GroupBy(f => f.Category);
                foreach (var group in groupedCommon)
                {
                    <optgroup label="@group.Key">
                        @foreach (var common in group)
                        {
                            <option value="@common.Name"
                                    data-calories="@common.Calories"
                                    data-protein="@common.Protein"
                                    data-fat="@common.Fat"
                                    data-carb="@common.Carbs">
                                @common.Name
                            </option>
                        }
                    </optgroup>
                }
            }
            <option value="其他" @(isOther ? "selected" : "")>其他</option>
        </select>
        <br />
        <input type="text" id="foodOtherInput" name="FoodOther" class="form-control mt-2"
               style="display:none;" placeholder="請輸入食物名稱" />*@
                @*<div>
            <label>數量</label>
            <input type="number" id="qtyInput" name="Quantity" class="form-control d-inline-block" value="1" min="1" style="width:80px;" onchange="updateNutrition()">
        </div>*@
                <div id="nutritionInputs" class="mt-2">
                    <label>熱量</label>
                    <input type="number" id="caloriesInput" name="Calories" class="form-control d-inline-block" style="width:100px;" value="0" step="0.1">
                    <br />
                    <label>蛋白質</label>
                    <input type="number" id="proteinInput" name="Protein" class="form-control d-inline-block" style="width:100px;" value="0" step="0.1">
                    <br />
                    <label>脂肪</label>
                    <input type="number" id="fatInput" name="Fat" class="form-control d-inline-block" style="width:100px;" value="0" step="0.1">
                    <br />
                    <label>碳水化合物</label>
                    <input type="number" id="carbInput" name="Carbs" class="form-control d-inline-block" style="width:100px;" value="0" step="0.1">
                </div>
                <br />
                <input type="hidden" id="categoryInput" name="Category" value="" />
                <button type="submit" id="saveBtn" class="btn btn-primary mt-2">➕ 儲存日記</button>
            </form>
        </div>
    </div>
</div>

<script>
var allFoods = [];
@foreach (var food in commonFoods ?? new List<PetShop.Models.CommonFood>())
{
    <text>
allFoods.push({
    name: "@food.Name",
    category: "@food.Category",
    calories: "@food.Calories",
    protein: "@food.Protein",
    fat: "@food.Fat",
    carb: "@food.Carbs"
});
    </text>
}

    var selectedChipFoods = [];

    function chipSuggest() {
        var input = document.getElementById('foodChipInput').value.toLowerCase();
        var suggestList = document.getElementById('chipSuggestList');
        suggestList.innerHTML = "";
        if (!input) return;
        var filtered = allFoods.filter(f => f.name.toLowerCase().indexOf(input) > -1 && !selectedChipFoods.some(s => s.name === f.name));
        filtered.slice(0, 8).forEach(function (f) {
            var item = document.createElement('a');
            item.className = "list-group-item list-group-item-action";
            item.style.display = "block";
            item.textContent = f.name;
            item.onclick = function () {
                // 安全取得預設數量；若不存在 qtyInput 則使用 1
                var qtyEl = document.getElementById('qtyInput');
                var defaultQty = qtyEl ? (parseInt(qtyEl.value) || 1) : 1;
                addChipFood(Object.assign({}, f, { qty: defaultQty }));
                document.getElementById('foodChipInput').value = "";
                suggestList.innerHTML = "";
            };
            suggestList.appendChild(item);
        });
    }

    function addChipFood(food) {
        if (selectedChipFoods.some(s => s.name === food.name)) return;
        selectedChipFoods.push(food);
        renderChipList();
        updateNutritionSum();
    }

    function removeChipFood(name) {
        selectedChipFoods = selectedChipFoods.filter(f => f.name !== name);
        renderChipList();
        updateNutritionSum();
    }

    function renderChipList() {
        var chipList = document.getElementById('foodChipList');
        chipList.innerHTML = "";
        selectedChipFoods.forEach(function (f, idx) {
            var chip = document.createElement('span');
            chip.className = "chip";
            var nameSpan = document.createElement('span');
            nameSpan.className = "chip-name";
            nameSpan.textContent = f.name;
            chip.appendChild(nameSpan);

            // 數量輸入（每個 item 獨立）
            var qtyInput = document.createElement('input');
            qtyInput.type = "number";
            qtyInput.min = "1";
            qtyInput.value = f.qty || 1;
            qtyInput.className = "chip-qty";
            qtyInput.onchange = function () {
                var v = parseInt(qtyInput.value) || 1;
                // 更新陣列中的數量
                selectedChipFoods[idx].qty = v;
                updateNutritionSum();
            };
            chip.appendChild(qtyInput);

            // 可選：顯示小型營養摘要（熱量）
            var small = document.createElement('small');
            small.style.marginLeft = "6px";
            var cal = parseFloat(f.calories) || 0;
            small.textContent = cal > 0 ? (cal * (f.qty || 1)) + " kcal" : "";
            small.className = "chip-cal";
            chip.appendChild(small);

            // close 按鈕
            var close = document.createElement('span');
            close.className = "close";
            close.textContent = "×";
            close.onclick = function () { removeChipFood(f.name); };
            chip.appendChild(close);

            chipList.appendChild(chip);
        });

        // 更新隱藏欄位（格式: name:qty,name2:qty2）
        var hidden = document.getElementById('selectedFoods');
        if (hidden) {
            hidden.value = selectedChipFoods.map(f => f.name + ":" + (f.qty || 1)).join(',');
        }
    }

    function updateNutritionSum() {
        var sumCalories = 0, sumProtein = 0, sumFat = 0, sumCarb = 0;
        selectedChipFoods.forEach(function (f) {
            var qty = parseInt(f.qty) || 1;
            sumCalories += (parseFloat(f.calories) || 0) * qty;
            sumProtein += (parseFloat(f.protein) || 0) * qty;
            sumFat += (parseFloat(f.fat) || 0) * qty;
            sumCarb += (parseFloat(f.carb) || 0) * qty;
        });

        var calEl = document.getElementById('caloriesInput');
        var proteinEl = document.getElementById('proteinInput');
        var fatEl = document.getElementById('fatInput');
        var carbEl = document.getElementById('carbInput');

        if (calEl) calEl.value = Math.round(sumCalories * 10) / 10;
        if (proteinEl) proteinEl.value = Math.round(sumProtein * 10) / 10;
        if (fatEl) fatEl.value = Math.round(sumFat * 10) / 10;
        if (carbEl) carbEl.value = Math.round(sumCarb * 10) / 10;

        // 更新每個 chip 顯示的 kcal（如果 render 時顯示）
        var chips = document.querySelectorAll('#foodChipList .chip');
        chips.forEach(function (chip, i) {
            var small = chip.querySelector('.chip-cal');
            if (small) {
                var f = selectedChipFoods[i];
                var cal = parseFloat(f.calories) || 0;
                small.textContent = cal > 0 ? (cal * (f.qty || 1)) + " kcal" : "";
            }
        });

        // 同步隱藏欄位（確保送出時為最新）
        var hidden = document.getElementById('selectedFoods');
        if (hidden) hidden.value = selectedChipFoods.map(f => f.name + ":" + (f.qty || 1)).join(',');
    }

/*    document.getElementById('qtyInput').addEventListener('change', updateNutritionSum);*/
</script>

<script>
    function hasSelectedFood() {
        const foods = document.getElementById('selectedFoods').value?.trim(); // "雞胸肉:1,地瓜:2"
        return !!foods;
    }

    function validateDiaryForm() {
        const meal = document.getElementById('MealType').value?.trim();
        const ok = meal && hasSelectedFood();
        if (!ok) {
            let msg = [];
            if (!meal) msg.push("請選擇餐別");
            if (!hasSelectedFood()) msg.push("請至少選擇一項食物");
            alert(msg.join("\n"));
        }
        return ok;
    }

    function toggleSubmit() {
        const meal = document.getElementById('MealType').value?.trim();
        const ok = meal && hasSelectedFood();
        const btn = document.getElementById('saveBtn');
        if (btn) btn.disabled = !ok;
    }

    // 綁定表單 submit
    (function () {
        const form = document.getElementById('dateForm');
        if (!form) return;
        form.addEventListener('submit', function (e) {
            if (!validateDiaryForm()) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        // 監聽餐別改變就更新按鈕狀態
        const meal = document.getElementById('MealType');
        if (meal) meal.addEventListener('change', toggleSubmit);

        // 讓 chip 增減後也會更新按鈕狀態
        const _renderChipList = renderChipList;
        renderChipList = function () {
            _renderChipList();
            toggleSubmit();
        };
        const _updateNutritionSum = updateNutritionSum;
        updateNutritionSum = function () {
            _updateNutritionSum();
            toggleSubmit();
        };

        document.addEventListener('DOMContentLoaded', toggleSubmit);
    })();
    //function onCommonSelectChange() {
    //    var commonSelect = document.getElementById('commonSelect');
    //    var foodOtherInput = document.getElementById('foodOtherInput');
    //    var selected = commonSelect.options[commonSelect.selectedIndex];
    //    if (commonSelect.value === "其他") {
    //        foodOtherInput.style.display = '';
    //        foodOtherInput.required = true;
    //    } else {
    //        foodOtherInput.style.display = 'none';
    //        foodOtherInput.required = false;
    //    }
    //}

    //document.getElementById('commonSelect').addEventListener('change', function () {
    //    var selected = this.options[this.selectedIndex];
    //    var category = selected.parentElement.label;
    //    var calories = selected.getAttribute('data-calories');
    //    var protein = selected.getAttribute('data-protein');
    //    var fat = selected.getAttribute('data-fat');
    //    var carb = selected.getAttribute('data-carb');
    //    if (calories && calories !== "其他") {
    //        document.getElementById('caloriesInput').value = calories;
    //        document.getElementById('proteinInput').value = protein;
    //        document.getElementById('fatInput').value = fat;
    //        document.getElementById('carbInput').value = carb;
    //    }
    //});

    function deleteDiary(id, btn) {
        console.log("前端傳入的 id:", id);
        if (!confirm('確定要刪除嗎？')) return;
        fetch('/Home/DeleteDiary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + encodeURIComponent(id)
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    btn.closest(".meal-entry").remove();
                    location.reload(); // 刪除後刷新頁面
                } else {
                    alert("刪除失敗，找不到資料");
                }
            });
    }

    (function () {
        // 如果使用者手動選過餐別，不再自動覆蓋
        var userPickedMeal = false;

        function parseLocalDateTime(value) {
            if (!value) return null;
            // 支援 "yyyy-MM-ddTHH:mm" 格式
            var parts = value.split('T');
            if (parts.length !== 2) {
                var d = new Date(value);
                return isNaN(d.getTime()) ? null : d;
            }
            var date = parts[0].split('-');
            var time = parts[1].split(':');
            var year = parseInt(date[0], 10);
            var month = parseInt(date[1], 10) - 1;
            var day = parseInt(date[2], 10);
            var hour = parseInt(time[0] || '0', 10);
            var minute = parseInt(time[1] || '0', 10);
            return new Date(year, month, day, hour, minute);
        }

        function inferMealTypeFromDate(date) {
            if (!date) return '點心';
            var h = date.getHours();
            // 可按需求調整區間
            if (h >= 5 && h < 11) return '早餐';    // 05:00 - 10:59
            if (h >= 11 && h < 15) return '午餐';  // 11:00 - 14:59
            if (h >= 17 && h < 21) return '晚餐';  // 17:00 - 20:59
            return '點心';
        }

        function applyInferredMeal() {
            var dtInput = document.getElementById('selectedDateTime');
            var mealSelect = document.getElementById('MealType');
            if (!dtInput || !mealSelect) return;
            if (userPickedMeal) return; // 若使用者已手動選過則不自動覆蓋
            var dt = parseLocalDateTime(dtInput.value);
            var inferred = inferMealTypeFromDate(dt);
            // 只有在 select 為空或為預設值時自動設
            if (!mealSelect.value || mealSelect.value.trim() === '') {
                mealSelect.value = inferred;
            } else {
                // 若你希望每次時間改變都強制更新，可取消上面 userPickedMeal 判斷並直接設定：
                // mealSelect.value = inferred;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var dtInput = document.getElementById('selectedDateTime');
            var mealSelect = document.getElementById('MealType');
            if (!dtInput || !mealSelect) return;

            // 若使用者改變 select，標記為手動選擇
            mealSelect.addEventListener('change', function () {
                if (mealSelect.value && mealSelect.value.trim() !== '') {
                    userPickedMeal = true;
                }
            });

            // 當時間即時改變（typing / picker）時觸發推論
            dtInput.addEventListener('input', applyInferredMeal);
            // 也綁 change（某些瀏覽器在 picker 完成時只觸發 change）
            dtInput.addEventListener('change', applyInferredMeal);

            // 初始載入時套用一次（若尚未手動選）
            applyInferredMeal();
        });
    })();

    //function updateNutrition() {
    //    // 取得選擇的食材
    //    var select = document.getElementById('commonSelect');
    //    var qty = parseInt(document.getElementById('qtyInput').value) || 1;
    //    var selected = select.options[select.selectedIndex];

    //    var calories = parseFloat(selected.getAttribute('data-calories')) || 0;
    //    var protein = parseFloat(selected.getAttribute('data-protein')) || 0;
    //    var fat = parseFloat(selected.getAttribute('data-fat')) || 0;
    //    var carb = parseFloat(selected.getAttribute('data-carb')) || 0;

    //    // 乘上數量
    //    document.getElementById('caloriesInput').value = calories * qty;
    //    document.getElementById('proteinInput').value = protein * qty;
    //    document.getElementById('fatInput').value = fat * qty;
    //    document.getElementById('carbInput').value = carb * qty;

    //    // 若要送到後端，可將結果填入隱藏欄位
    //    document.getElementById('caloriesInput').value = totalCalories;
    //    // 其他營養成分也可用隱藏欄位傳送
    //}

    //// 初始化
    //document.getElementById('commonSelect').addEventListener('change', updateNutritionInputs);
    //document.getElementById('qtyInput').addEventListener('change', updateNutritionInputs);

</script>
